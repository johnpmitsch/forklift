@startuml

note as general
  This diagram outlines the design of all components and
  their interactions within the OpenShift/Kubernetes environment.
  Squares represent pods, with each entry inside represeting a
  running container within the pod (thus, any square can be scaled independently).
  Cylinders represent volume mounts that are shared amongst pods.
end note

/' Pods '/
node "Postgres" {
  [Postgres] as postgres
}

node "Foreman Web Application" {
  node "Foreman" {
    [Foreman] as foreman
    [Foreman Tasks] as foreman_tasks
    [Katello] as katello
  }
}

node "Foreman Tasks" {
  node "Tasks via Dynflow" {
    [Foreman Tasks] as foreman_tasks
    [Dynflow] as dynflow
  }
}

node "Candlepin" {
  [Candlepin] as candlepin
}

node "MongoDB" {
  [MongoDB] as mongodb
}

node "Pulp" {
  [Pulp] as pulp
}

node "Pulp Worker" {
  [Pulp Worker] as pulp_worker
}

node "Pulp Celery Beat" {
  [Pulp Celery Beat] as pulp_celery_beat
}

node "Pulp Resource Manager" {
  [Pulp Resource Manager] as pulp_resource_manager
}

node "Qpid" {
  [Qpid] as qpid
}

node "Foreman Proxy" {
  [Foreman Proxy] as foreman_proxy
}

node "Puppet Server" {
  [Puppet Server] as puppet_server
}

node "Content Server" {
  [Content Server] as content_server
}

/' Volumes '/
database "Pulp Data Volume" {
  folder "Content" {
    [/var/lib/pulp] as pulp_content
  }
}

database "Puppet Data Volume" {
  folder "Puppet environments" {
    [/etc/puppet] as puppet_environments
  }
}

database "Postgres Data Volume" {
  folder "Postgres Database" {
    [Postgres Datastore] as postgres_datastore
  }
}

database "MongoDB Data Volume" {
  folder "MongoDB Database" {
    [MongoDB Datastore] as mongodb_datastore
  }
}

/' Connections '/
postgres --> postgres_datastore
mongodb --> mongodb_datastore

pulp --> mongodb
pulp_worker --> mongodb

pulp_worker --> qpid
pulp_resource_manager --> qpid
pulp_celery_beat --> qpid

pulp --> pulp_content
pulp_worker --> pulp_content
pulp --> puppet_environments
pulp_worker --> puppet_environments

content_server --> pulp_content

candlepin --> postgres
candlepin --> qpid

foreman --> postgres
dynflow --> postgres
katello --> pulp
katello --> candlepin
katello --> qpid

foreman_proxy --> puppet_server
foreman_proxy <--> foreman

puppet_server --> puppet_environments

@enduml
