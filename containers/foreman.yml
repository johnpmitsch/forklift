- name: Manage the lifecycle of Foreman on OpenShiftâ„¢
  hosts: localhost
  gather_facts: no
  connection: local
  # Include Ansible Kubernetes and OpenShift modules
  roles:
    - role: ansible-kubernetes-modules
  vars_files:
    - secrets.yml
  # Tasks for setting the application state. Valid tags include: start, stop, restart, destroy
  tasks:
    - name: Create project foreman
      openshift_v1_project:
          name: foreman
          display_name: Foreman
          description: Foreman stack
          state: present
      tags:
        - start
    - name: Destroy the application by removing project foreman
      openshift_v1_project:
          name: foreman
          state: absent
      tags:
        - destroy
    - name: Create Secret
      k8s_v1_secret:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Secret
              metadata:
                  name: keys
                  namespace: foreman
              type: Opaque
              data:
                  pulp.key: '{{ pulp_key | b64encode }}'
                  pulp-client.key: '{{ pulp_client_key | b64encode }}'
                  ca.key: '{{ ca_key | b64encode }}'
      tags:
        - start
    - name: Create Secret
      k8s_v1_secret:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Secret
              metadata:
                  name: ca
                  namespace: foreman
              type: Opaque
              data:
                  ca.crt: '{{ ca_crt | b64encode }}'
                  ca.key: '{{ ca_key | b64encode }}'
      tags:
        - start
    - name: Create Secret
      k8s_v1_secret:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Secret
              metadata:
                  name: certs
                  namespace: foreman
              type: Opaque
              data:
                  ca.crt: '{{ ca_crt | b64encode }}'
                  pulp-client.crt: '{{ pulp_client_crt | b64encode }}'
                  pulp.crt: '{{ pulp_crt | b64encode }}'
      tags:
        - start
    - name: Create service
      k8s_v1_service:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Service
              metadata:
                  name: foreman
                  namespace: foreman
                  labels:
                      app: foreman
                      service: foreman
              spec:
                  selector:
                      app: foreman
                      service: foreman
                  ports:
                    - protocol: TCP
                      targetPort: 8080
                      name: port-8080-tcp
                      port: 8080
      tags:
        - start
    - name: Create service
      k8s_v1_service:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Service
              metadata:
                  name: memcached
                  namespace: foreman
                  labels:
                      app: foreman
                      service: memcached
              spec:
                  selector:
                      app: foreman
                      service: memcached
                  ports:
                    - protocol: TCP
                      targetPort: 11211
                      name: port-11211-tcp
                      port: 11211
      tags:
        - start
    - name: Create service
      k8s_v1_service:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Service
              metadata:
                  name: foreman-proxy
                  namespace: foreman
                  labels:
                      app: foreman
                      service: foreman-proxy
              spec:
                  selector:
                      app: foreman
                      service: foreman-proxy
                  ports:
                    - protocol: TCP
                      targetPort: 8080
                      name: port-8080-tcp
                      port: 8080
      tags:
        - start
    - name: Create service
      k8s_v1_service:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Service
              metadata:
                  name: puppet
                  namespace: foreman
                  labels:
                      app: foreman
                      service: puppet
              spec:
                  selector:
                      app: foreman
                      service: puppet
                  ports:
                    - protocol: TCP
                      targetPort: 8140
                      name: port-8140-tcp
                      port: 8140
      tags:
        - start
    - name: Create service
      k8s_v1_service:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Service
              metadata:
                  name: candlepin
                  namespace: foreman
                  labels:
                      app: foreman
                      service: candlepin
              spec:
                  selector:
                      app: foreman
                      service: candlepin
                  ports:
                    - protocol: TCP
                      targetPort: 8080
                      name: port-8080-tcp
                      port: 8080
      tags:
        - start
    - name: Create service
      k8s_v1_service:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Service
              metadata:
                  name: postgres
                  namespace: foreman
                  labels:
                      app: foreman
                      service: postgres
              spec:
                  selector:
                      app: foreman
                      service: postgres
                  ports:
                    - protocol: TCP
                      targetPort: 5432
                      name: port-5432-tcp
                      port: 5432
      tags:
        - start
    - name: Create service
      k8s_v1_service:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Service
              metadata:
                  name: pulp
                  namespace: foreman
                  labels:
                      app: foreman
                      service: pulp
              spec:
                  selector:
                      app: foreman
                      service: pulp
                  ports:
                    - protocol: TCP
                      targetPort: 443
                      name: port-443-tcp
                      port: 443
      tags:
        - start
    - name: Create service
      k8s_v1_service:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Service
              metadata:
                  name: mongodb
                  namespace: foreman
                  labels:
                      app: foreman
                      service: mongodb
              spec:
                  selector:
                      app: foreman
                      service: mongodb
                  ports:
                    - protocol: TCP
                      targetPort: 27017
                      name: port-27017-tcp
                      port: 27017
      tags:
        - start
    - name: Create service
      k8s_v1_service:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Service
              metadata:
                  name: qpid
                  namespace: foreman
                  labels:
                      app: foreman
                      service: qpid
              spec:
                  selector:
                      app: foreman
                      service: qpid
                  ports:
                    - protocol: TCP
                      targetPort: 5672
                      name: port-5672-tcp
                      port: 5672
      tags:
        - start
    - name: Create service
      k8s_v1_service:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Service
              metadata:
                  name: content-server
                  namespace: foreman
                  labels:
                      app: foreman
                      service: content-server
              spec:
                  selector:
                      app: foreman
                      service: content-server
                  ports:
                    - protocol: TCP
                      targetPort: 8080
                      name: port-8080-tcp
                      port: 8080
      tags:
        - start
    - name: Remove service
      k8s_v1_service:
          state: absent
          name: foreman-base
          namespace: foreman
      tags:
        - start
    - name: Remove service
      k8s_v1_service:
          state: absent
          name: pulp-base
          namespace: foreman
      tags:
        - start
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: foreman
                  labels:
                      app: foreman
                      service: foreman
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: foreman
                      spec:
                          containers:
                            - name: foreman
                              securityContext: {}
                              state: present
                              volumeMounts:
                                - readOnly: true
                                  mountPath: /etc/pki/katello/private
                                  name: keys
                                - readOnly: true
                                  mountPath: /etc/pki/katello/certs
                                  name: certs
                              env:
                                - name: POSTGRES_DB
                                  value: foreman
                                - name: POSTGRES_USER
                                  value: foreman
                                - name: POSTGRES_PASSWORD
                                  value: foreman
                                - name: SEED_ADMIN_USER
                                  value: admin
                                - name: SEED_ADMIN_PASSWORD
                                  value: changeme
                                - name: RAILS_ENV
                                  value: production
                              args:
                                - /usr/bin/start-foreman.sh
                              command:
                                - /usr/bin/entrypoint.sh
                              ports:
                                - protocol: TCP
                                  containerPort: 8080
                              image: projgriffin/foreman-foreman:latest
                          volumes:
                            - secret:
                                  items: &id001
                                    - path: ca.key
                                      key: ca.key
                                    - path: pulp-client.key
                                      key: pulp-client.key
                                  secretName: keys
                              name: keys
                            - secret:
                                  items: &id002
                                    - path: ca.crt
                                      key: ca.crt
                                    - path: pulp-client.crt
                                      key: pulp-client.crt
                                  secretName: certs
                              name: certs
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: dynflow
                  labels:
                      app: foreman
                      service: dynflow
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: dynflow
                      spec:
                          containers:
                            - name: dynflow
                              securityContext: {}
                              state: present
                              volumeMounts:
                                - readOnly: true
                                  mountPath: /etc/pki/katello/private
                                  name: keys
                                - readOnly: true
                                  mountPath: /etc/pki/katello/certs
                                  name: certs
                              env:
                                - name: POSTGRES_DB
                                  value: foreman
                                - name: POSTGRES_USER
                                  value: foreman
                                - name: POSTGRES_PASSWORD
                                  value: foreman
                                - name: RAILS_ENV
                                  value: production
                              args:
                                - /usr/bin/start-dynflowd.sh
                              command:
                                - /usr/bin/entrypoint.sh
                              image: projgriffin/foreman-dynflow:latest
                          volumes:
                            - secret:
                                  items: &id003
                                    - path: ca.key
                                      key: ca.key
                                    - path: pulp-client.key
                                      key: pulp-client.key
                                  secretName: keys
                              name: keys
                            - secret:
                                  items: &id004
                                    - path: ca.crt
                                      key: ca.crt
                                    - path: pulp-client.crt
                                      key: pulp-client.crt
                                  secretName: certs
                              name: certs
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: memcached
                  labels:
                      app: foreman
                      service: memcached
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: memcached
                      spec:
                          containers:
                            - name: memcached
                              securityContext: {}
                              state: present
                              image: manageiq/memcached
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: foreman-proxy
                  labels:
                      app: foreman
                      service: foreman-proxy
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: foreman-proxy
                      spec:
                          containers:
                            - name: foreman-proxy
                              securityContext: {}
                              state: present
                              args:
                                - /usr/bin/start-foreman-proxy.sh
                              image: projgriffin/foreman-foreman-proxy:latest
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: foreman-proxy-register
                  labels:
                      app: foreman
                      service: foreman-proxy-register
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: foreman-proxy-register
                      spec:
                          containers:
                            - name: foreman-proxy-register
                              securityContext: {}
                              state: present
                              env:
                                - name: FOREMAN_PROXY_SERVICE_HOST
                                  value: foreman-proxy
                                - name: FOREMAN_PROXY_SERVICE_PORT
                                  value: '8080'
                                - name: FOREMAN_SERVICE_HOST
                                  value: foreman
                                - name: FOREMAN_SERVICE_PORT
                                  value: '8080'
                              args:
                                - /usr/bin/register.sh
                              image: projgriffin/foreman-foreman-proxy-register:latest
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: puppet
                  labels:
                      app: foreman
                      service: puppet
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: puppet
                      spec:
                          containers:
                            - name: puppet
                              securityContext: {}
                              state: present
                              volumeMounts:
                                - readOnly: false
                                  mountPath: /etc/puppet
                                  name: puppet-data
                              image: puppet/puppetserver
                          volumes:
                            - name: puppet-data
                              persistentVolumeClaim:
                                  claimName: puppet-data
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: candlepin
                  labels:
                      app: foreman
                      service: candlepin
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: candlepin
                      spec:
                          containers:
                            - name: candlepin
                              securityContext: {}
                              state: present
                              volumeMounts:
                                - readOnly: true
                                  mountPath: /etc/candlepin/certs
                                  name: ca
                              env:
                                - name: POSTGRES_DB
                                  value: foreman
                                - name: POSTGRES_USER
                                  value: foreman
                                - name: POSTGRES_PASSWORD
                                  value: foreman
                                - name: POSTGRES_PORT
                                  value: '5432'
                                - name: POSTGRES_SERVICE
                                  value: postgres
                                - name: QPID_SERVICE
                                  value: qpid
                                - name: QPID_PORT
                                  value: '5672'
                              args:
                                - /usr/bin/start_candlepin.sh
                              command:
                                - /usr/bin/entrypoint.sh
                              image: projgriffin/foreman-candlepin:latest
                          volumes:
                            - secret:
                                  items: &id005
                                    - path: candlepin-ca.key
                                      key: ca.key
                                    - path: candlepin-ca.crt
                                      key: ca.crt
                                  secretName: ca
                              name: ca
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: postgres
                  labels:
                      app: foreman
                      service: postgres
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: postgres
                      spec:
                          containers:
                            - name: postgres
                              securityContext: {}
                              state: present
                              env:
                                - name: POSTGRES_DB
                                  value: foreman
                                - name: POSTGRES_USER
                                  value: foreman
                                - name: POSTGRES_PASS
                                  value: foreman
                                - name: PGDATA
                                  value: /var/lib/pgsql/data/userdata
                              volumeMounts:
                                - readOnly: false
                                  mountPath: /var/lib/pgsql/data
                                  name: postgres-data
                              image: ansible/postgresql
                          volumes:
                            - name: postgres-data
                              persistentVolumeClaim:
                                  claimName: postgres-data
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: pulp
                  labels:
                      app: foreman
                      service: pulp
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: pulp
                      spec:
                          containers:
                            - name: pulp
                              securityContext: {}
                              state: present
                              volumeMounts:
                                - readOnly: true
                                  mountPath: /etc/pki/pulp/private
                                  name: keys
                                - readOnly: true
                                  mountPath: /etc/pki/pulp/certs
                                  name: certs
                              args:
                                - /usr/bin/start_httpd.sh
                              command:
                                - /usr/bin/entrypoint.sh
                              image: projgriffin/foreman-pulp:latest
                          volumes:
                            - secret:
                                  items: &id006
                                    - path: pulp.key
                                      key: pulp.key
                                  secretName: keys
                              name: keys
                            - secret:
                                  items: &id007
                                    - path: ca.crt
                                      key: ca.crt
                                    - path: pulp.crt
                                      key: pulp.crt
                                  secretName: certs
                              name: certs
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: pulp-worker
                  labels:
                      app: foreman
                      service: pulp-worker
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: pulp-worker
                      spec:
                          containers:
                            - name: pulp-worker
                              securityContext: {}
                              state: present
                              command:
                                - /usr/bin/entrypoint.sh
                              volumeMounts:
                                - readOnly: false
                                  mountPath: /var/lib/pulp
                                  name: pulp-data
                                - readOnly: false
                                  mountPath: /etc/puppet
                                  name: puppet-data
                              image: projgriffin/foreman-pulp-worker:latest
                          volumes:
                            - name: pulp-data
                              persistentVolumeClaim:
                                  claimName: pulp-data
                            - name: puppet-data
                              persistentVolumeClaim:
                                  claimName: puppet-data
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: pulp-celerybeat
                  labels:
                      app: foreman
                      service: pulp-celerybeat
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: pulp-celerybeat
                      spec:
                          containers:
                            - name: pulp-celerybeat
                              securityContext: {}
                              state: present
                              command:
                                - /usr/bin/entrypoint.sh
                              image: projgriffin/foreman-pulp-celerybeat:latest
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: pulp-resource-manager
                  labels:
                      app: foreman
                      service: pulp-resource-manager
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: pulp-resource-manager
                      spec:
                          containers:
                            - name: pulp-resource-manager
                              securityContext: {}
                              state: present
                              command:
                                - /usr/bin/entrypoint.sh
                              image: projgriffin/foreman-pulp-resource-manager:latest
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: mongodb
                  labels:
                      app: foreman
                      service: mongodb
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: mongodb
                      spec:
                          containers:
                            - name: mongodb
                              securityContext: {}
                              state: present
                              env:
                                - name: MONGODB_USER
                                  value: admin
                                - name: MONGODB_PASSWORD
                                  value: admin
                                - name: MONGODB_DATABASE
                                  value: pulp_database
                                - name: MONGODB_ADMIN_PASSWORD
                                  value: admin
                              args:
                                - run-mongod
                              volumeMounts:
                                - readOnly: false
                                  mountPath: /var/lib/mongodb/data
                                  name: mongodb-data
                              image: projgriffin/foreman-mongodb:latest
                          volumes:
                            - name: mongodb-data
                              persistentVolumeClaim:
                                  claimName: mongodb-data
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: qpid
                  labels:
                      app: foreman
                      service: qpid
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: qpid
                      spec:
                          containers:
                            - name: qpid
                              securityContext: {}
                              state: present
                              args:
                                - /usr/bin/startup.sh
                              image: projgriffin/foreman-qpid:latest
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Stop running containers by scaling replicas down to 0
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: content-server
                  labels:
                      app: foreman
                      service: content-server
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: content-server
                      spec:
                          containers:
                            - name: content-server
                              securityContext: {}
                              state: present
                              volumeMounts:
                                - readOnly: true
                                  mountPath: /etc/pki/pulp/private
                                  name: keys
                                - readOnly: true
                                  mountPath: /etc/pki/pulp/certs
                                  name: certs
                                - readOnly: false
                                  mountPath: /var/lib/pulp
                                  name: pulp-data
                              args:
                                - /usr/bin/start_httpd.sh
                              ports:
                                - protocol: TCP
                                  containerPort: 8080
                              image: projgriffin/foreman-content-server:latest
                          volumes:
                            - secret:
                                  items: &id008
                                    - path: pulp.key
                                      key: pulp.key
                                  secretName: keys
                              name: keys
                            - secret:
                                  items: &id009
                                    - path: ca.crt
                                      key: ca.crt
                                    - path: pulp.crt
                                      key: pulp.crt
                                  secretName: certs
                              name: certs
                            - name: pulp-data
                              persistentVolumeClaim:
                                  claimName: pulp-data
                  replicas: 0
                  strategy:
                      type: Rolling
      tags:
        - stop
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: foreman
                  labels:
                      app: foreman
                      service: foreman
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: foreman
                      spec:
                          containers:
                            - name: foreman
                              securityContext: {}
                              state: present
                              volumeMounts:
                                - readOnly: true
                                  mountPath: /etc/pki/katello/private
                                  name: keys
                                - readOnly: true
                                  mountPath: /etc/pki/katello/certs
                                  name: certs
                              env:
                                - name: POSTGRES_DB
                                  value: foreman
                                - name: POSTGRES_USER
                                  value: foreman
                                - name: POSTGRES_PASSWORD
                                  value: foreman
                                - name: SEED_ADMIN_USER
                                  value: admin
                                - name: SEED_ADMIN_PASSWORD
                                  value: changeme
                                - name: RAILS_ENV
                                  value: production
                              args:
                                - /usr/bin/start-foreman.sh
                              command:
                                - /usr/bin/entrypoint.sh
                              ports:
                                - protocol: TCP
                                  containerPort: 8080
                              image: projgriffin/foreman-foreman:latest
                          volumes:
                            - secret:
                                  items: *id001
                                  secretName: keys
                              name: keys
                            - secret:
                                  items: *id002
                                  secretName: certs
                              name: certs
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: dynflow
                  labels:
                      app: foreman
                      service: dynflow
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: dynflow
                      spec:
                          containers:
                            - name: dynflow
                              securityContext: {}
                              state: present
                              volumeMounts:
                                - readOnly: true
                                  mountPath: /etc/pki/katello/private
                                  name: keys
                                - readOnly: true
                                  mountPath: /etc/pki/katello/certs
                                  name: certs
                              env:
                                - name: POSTGRES_DB
                                  value: foreman
                                - name: POSTGRES_USER
                                  value: foreman
                                - name: POSTGRES_PASSWORD
                                  value: foreman
                                - name: RAILS_ENV
                                  value: production
                              args:
                                - /usr/bin/start-dynflowd.sh
                              command:
                                - /usr/bin/entrypoint.sh
                              image: projgriffin/foreman-dynflow:latest
                          volumes:
                            - secret:
                                  items: *id003
                                  secretName: keys
                              name: keys
                            - secret:
                                  items: *id004
                                  secretName: certs
                              name: certs
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: memcached
                  labels:
                      app: foreman
                      service: memcached
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: memcached
                      spec:
                          containers:
                            - name: memcached
                              securityContext: {}
                              state: present
                              image: manageiq/memcached
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: foreman-proxy
                  labels:
                      app: foreman
                      service: foreman-proxy
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: foreman-proxy
                      spec:
                          containers:
                            - name: foreman-proxy
                              securityContext: {}
                              state: present
                              args:
                                - /usr/bin/start-foreman-proxy.sh
                              image: projgriffin/foreman-foreman-proxy:latest
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: foreman-proxy-register
                  labels:
                      app: foreman
                      service: foreman-proxy-register
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: foreman-proxy-register
                      spec:
                          containers:
                            - name: foreman-proxy-register
                              securityContext: {}
                              state: present
                              env:
                                - name: FOREMAN_PROXY_SERVICE_HOST
                                  value: foreman-proxy
                                - name: FOREMAN_PROXY_SERVICE_PORT
                                  value: '8080'
                                - name: FOREMAN_SERVICE_HOST
                                  value: foreman
                                - name: FOREMAN_SERVICE_PORT
                                  value: '8080'
                              args:
                                - /usr/bin/register.sh
                              image: projgriffin/foreman-foreman-proxy-register:latest
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: puppet
                  labels:
                      app: foreman
                      service: puppet
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: puppet
                      spec:
                          containers:
                            - name: puppet
                              securityContext: {}
                              state: present
                              volumeMounts:
                                - readOnly: false
                                  mountPath: /etc/puppet
                                  name: puppet-data
                              image: puppet/puppetserver
                          volumes:
                            - name: puppet-data
                              persistentVolumeClaim:
                                  claimName: puppet-data
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: candlepin
                  labels:
                      app: foreman
                      service: candlepin
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: candlepin
                      spec:
                          containers:
                            - name: candlepin
                              securityContext: {}
                              state: present
                              volumeMounts:
                                - readOnly: true
                                  mountPath: /etc/candlepin/certs
                                  name: ca
                              env:
                                - name: POSTGRES_DB
                                  value: foreman
                                - name: POSTGRES_USER
                                  value: foreman
                                - name: POSTGRES_PASSWORD
                                  value: foreman
                                - name: POSTGRES_PORT
                                  value: '5432'
                                - name: POSTGRES_SERVICE
                                  value: postgres
                                - name: QPID_SERVICE
                                  value: qpid
                                - name: QPID_PORT
                                  value: '5672'
                              args:
                                - /usr/bin/start_candlepin.sh
                              command:
                                - /usr/bin/entrypoint.sh
                              image: projgriffin/foreman-candlepin:latest
                          volumes:
                            - secret:
                                  items: *id005
                                  secretName: ca
                              name: ca
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: postgres
                  labels:
                      app: foreman
                      service: postgres
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: postgres
                      spec:
                          containers:
                            - name: postgres
                              securityContext: {}
                              state: present
                              env:
                                - name: POSTGRES_DB
                                  value: foreman
                                - name: POSTGRES_USER
                                  value: foreman
                                - name: POSTGRES_PASS
                                  value: foreman
                                - name: PGDATA
                                  value: /var/lib/pgsql/data/userdata
                              volumeMounts:
                                - readOnly: false
                                  mountPath: /var/lib/pgsql/data
                                  name: postgres-data
                              image: ansible/postgresql
                          volumes:
                            - name: postgres-data
                              persistentVolumeClaim:
                                  claimName: postgres-data
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: pulp
                  labels:
                      app: foreman
                      service: pulp
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: pulp
                      spec:
                          containers:
                            - name: pulp
                              securityContext: {}
                              state: present
                              volumeMounts:
                                - readOnly: true
                                  mountPath: /etc/pki/pulp/private
                                  name: keys
                                - readOnly: true
                                  mountPath: /etc/pki/pulp/certs
                                  name: certs
                              args:
                                - /usr/bin/start_httpd.sh
                              command:
                                - /usr/bin/entrypoint.sh
                              image: projgriffin/foreman-pulp:latest
                          volumes:
                            - secret:
                                  items: *id006
                                  secretName: keys
                              name: keys
                            - secret:
                                  items: *id007
                                  secretName: certs
                              name: certs
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: pulp-worker
                  labels:
                      app: foreman
                      service: pulp-worker
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: pulp-worker
                      spec:
                          containers:
                            - name: pulp-worker
                              securityContext: {}
                              state: present
                              command:
                                - /usr/bin/entrypoint.sh
                              volumeMounts:
                                - readOnly: false
                                  mountPath: /var/lib/pulp
                                  name: pulp-data
                                - readOnly: false
                                  mountPath: /etc/puppet
                                  name: puppet-data
                              image: projgriffin/foreman-pulp-worker:latest
                          volumes:
                            - name: pulp-data
                              persistentVolumeClaim:
                                  claimName: pulp-data
                            - name: puppet-data
                              persistentVolumeClaim:
                                  claimName: puppet-data
                  replicas: 4
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: pulp-celerybeat
                  labels:
                      app: foreman
                      service: pulp-celerybeat
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: pulp-celerybeat
                      spec:
                          containers:
                            - name: pulp-celerybeat
                              securityContext: {}
                              state: present
                              command:
                                - /usr/bin/entrypoint.sh
                              image: projgriffin/foreman-pulp-celerybeat:latest
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: pulp-resource-manager
                  labels:
                      app: foreman
                      service: pulp-resource-manager
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: pulp-resource-manager
                      spec:
                          containers:
                            - name: pulp-resource-manager
                              securityContext: {}
                              state: present
                              command:
                                - /usr/bin/entrypoint.sh
                              image: projgriffin/foreman-pulp-resource-manager:latest
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: mongodb
                  labels:
                      app: foreman
                      service: mongodb
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: mongodb
                      spec:
                          containers:
                            - name: mongodb
                              securityContext: {}
                              state: present
                              env:
                                - name: MONGODB_USER
                                  value: admin
                                - name: MONGODB_PASSWORD
                                  value: admin
                                - name: MONGODB_DATABASE
                                  value: pulp_database
                                - name: MONGODB_ADMIN_PASSWORD
                                  value: admin
                              args:
                                - run-mongod
                              volumeMounts:
                                - readOnly: false
                                  mountPath: /var/lib/mongodb/data
                                  name: mongodb-data
                              image: projgriffin/foreman-mongodb:latest
                          volumes:
                            - name: mongodb-data
                              persistentVolumeClaim:
                                  claimName: mongodb-data
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: qpid
                  labels:
                      app: foreman
                      service: qpid
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: qpid
                      spec:
                          containers:
                            - name: qpid
                              securityContext: {}
                              state: present
                              args:
                                - /usr/bin/startup.sh
                              image: projgriffin/foreman-qpid:latest
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Create deployment, and scale replicas up
      openshift_v1_deployment_config:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: deployment_config
              metadata:
                  name: content-server
                  labels:
                      app: foreman
                      service: content-server
                  namespace: foreman
              spec:
                  template:
                      metadata:
                          labels:
                              app: foreman
                              service: content-server
                      spec:
                          containers:
                            - name: content-server
                              securityContext: {}
                              state: present
                              volumeMounts:
                                - readOnly: true
                                  mountPath: /etc/pki/pulp/private
                                  name: keys
                                - readOnly: true
                                  mountPath: /etc/pki/pulp/certs
                                  name: certs
                                - readOnly: false
                                  mountPath: /var/lib/pulp
                                  name: pulp-data
                              args:
                                - /usr/bin/start_httpd.sh
                              ports:
                                - protocol: TCP
                                  containerPort: 8080
                              image: projgriffin/foreman-content-server:latest
                          volumes:
                            - secret:
                                  items: *id008
                                  secretName: keys
                              name: keys
                            - secret:
                                  items: *id009
                                  secretName: certs
                              name: certs
                            - name: pulp-data
                              persistentVolumeClaim:
                                  claimName: pulp-data
                  replicas: 1
                  strategy:
                      type: Rolling
      tags:
        - start
        - restart
    - name: Remove deployment
      openshift_v1_deployment_config:
          state: absent
          name: foreman-base
          namespace: foreman
      tags:
        - start
        - restart
    - name: Remove deployment
      openshift_v1_deployment_config:
          state: absent
          name: pulp-base
          namespace: foreman
      tags:
        - start
        - restart
    - name: Create PVC
      k8s_v1_persistent_volume_claim:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: PersistentVolumeClaim
              metadata:
                  name: puppet-data
                  namespace: foreman
              spec:
                  resources:
                      requests:
                          storage: 1Gi
                  accessModes:
                    - ReadWriteOnce
      tags:
        - start
    - name: Create PVC
      k8s_v1_persistent_volume_claim:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: PersistentVolumeClaim
              metadata:
                  name: mongodb-data
                  namespace: foreman
              spec:
                  resources:
                      requests:
                          storage: 1Gi
                  accessModes:
                    - ReadWriteOnce
      tags:
        - start
    - name: Create PVC
      k8s_v1_persistent_volume_claim:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: PersistentVolumeClaim
              metadata:
                  name: postgres-data
                  namespace: foreman
              spec:
                  resources:
                      requests:
                          storage: 1Gi
                  accessModes:
                    - ReadWriteOnce
      tags:
        - start
    - name: Create PVC
      k8s_v1_persistent_volume_claim:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: PersistentVolumeClaim
              metadata:
                  name: pulp-data
                  namespace: foreman
              spec:
                  resources:
                      requests:
                          storage: 1Gi
                  accessModes:
                    - ReadWriteOnce
      tags:
        - start
    - name: Create route
      openshift_v1_route:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Route
              metadata:
                  name: foreman-8080
                  namespace: foreman
                  labels:
                      app: foreman
                      service: foreman
              spec:
                  to:
                      kind: Service
                      name: foreman
                  port:
                      targetPort: port-8080-tcp
      tags:
        - start
    - name: Create route
      openshift_v1_route:
          state: present
          force: false
          resource_definition:
              apiVersion: v1
              kind: Route
              metadata:
                  name: content-server-8080
                  namespace: foreman
                  labels:
                      app: foreman
                      service: content-server
              spec:
                  to:
                      kind: Service
                      name: content-server
                  port:
                      targetPort: port-8080-tcp
      tags:
        - start
    - name: Remove route
      openshift_v1_route:
          state: absent
          name: foreman-base
          namespace: foreman
      tags:
        - start
    - name: Remove route
      openshift_v1_route:
          state: absent
          name: pulp-base
          namespace: foreman
      tags:
        - start
